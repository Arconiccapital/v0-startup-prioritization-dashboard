// Prisma schema for Startup Prioritization Dashboard
// This schema is designed for Vercel Postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model Startup {
  id              String   @id @default(uuid())
  name            String
  sector          String
  stage           String?
  country         String
  description     String?
  team            String?
  metrics         String?
  score           Float    @default(0)
  rank            Int      @default(0)
  feedback        Json     @default("[]") // Array of feedback items
  pipelineStage   String   @default("Screening")

  // User-specific shortlists (many-to-many)
  shortlistedBy   UserShortlist[]

  // AI Scores (stored as JSON for flexibility)
  aiScores        Json? // {llm, ml, sentiment, llmAnalysis, mlAnalysis, sentimentAnalysis}

  // Rationale (stored as JSON)
  rationale       Json? // {whyInvest: string[], whyNot: string[], keyStrengths, areasOfConcern}

  // Detailed Metrics (stored as JSON)
  detailedMetrics Json? // {arr, growth, teamSize, fundingStage}

  // Company Info (stored as JSON)
  companyInfo     Json? // {founded, headquarters, website, linkedin, employeeCount, fundingRaised, location, area, ventureCapitalFirm, founders}

  // Market Info (stored as JSON)
  marketInfo      Json? // {b2bOrB2c, subIndustry, marketSize, aiDisruptionPropensity, industry, targetPersona, marketCompetitionAnalysis}

  // Product Info (stored as JSON)
  productInfo     Json? // {productName, horizontalOrVertical, problemSolved, moat, productStage, technologyStack, intellectualProperty}

  // Business Model Info (stored as JSON)
  businessModelInfo Json? // {revenueModel, pricingStrategy, unitEconomics, customerAcquisitionCost, lifetimeValue}

  // Sales Info (stored as JSON)
  salesInfo       Json? // {salesMotion, salesCycleLength, salesComplexity, gtmStrategy, channels, currentCustomers, customerRetention}

  // Team Info (stored as JSON)
  teamInfo        Json? // {foundersEducation, foundersPriorExperience, keyTeamMembers, teamDepth, teamExecutionAssessment}

  // Competitive Info (stored as JSON)
  competitiveInfo Json? // {competitors, industryMultiples}

  // Risk Info (stored as JSON)
  riskInfo        Json? // {regulatoryRisk, marketRisk, executionRisk}

  // Opportunity Info (stored as JSON)
  opportunityInfo Json? // {exitPotential}

  // Threshold Issues (separate table for better querying)
  thresholdIssues ThresholdIssue[]

  // Portfolio Investment (one-to-one for closed deals)
  portfolioInvestment PortfolioInvestment?

  // Founders (many-to-many through FounderCompany)
  founders FounderCompany[]

  // Initial Assessment (stored as JSON)
  initialAssessment Json? // {marketOpportunity, teamQuality, productInnovation, businessModel, competitivePosition, commentary}

  // Investment Scorecard (stored as JSON)
  investmentScorecard Json? // Array of scorecards: [{reviewerName, scores, totalScore, lastUpdated}, ...]

  // Investment Memo (stored as JSON)
  investmentMemo  Json? // {sections: {executive, thesis, market, product, business, gtm, team, competitive, risk, recommendation}, generatedAt}

  // Investment Decision (stored as JSON) - IC2 decision tracking
  investmentDecision Json? // {decision, decisionDate, votes: [{name, vote, rationale}], categories: {team, market, product, traction, competition, dealTerms}, reasonsToInvest, reasonsNotToInvest, additionalContext, nextSteps}

  // Valuation & Terms (stored as JSON) - DD stage onwards
  valuationData     Json? // {valuation: {proposedPreMoney, proposedPostMoney, askingValuation, ourOffer, comparableCompanies, valuationNotes}, financials: {currentARR, currentMRR, runway, burnRate, grossMargin, lastRoundValuation, lastRoundDate, totalRaised, revenueGrowthRate, financialNotes}, termSheet: {roundSize, ourAllocation, ownershipTarget, proRataRights, boardSeat, boardObserver, liquidationPreference, antiDilution, dividends, votingRights, protectiveProvisions, otherTerms, termSheetStatus, termSheetNotes}, lastUpdated}

  // Legal Diligence (stored as JSON) - DD stage onwards
  legalDiligence    Json? // {checklist: {corporateDocs, ip, contracts, employment, compliance}, issues: [{id, category, issue, severity, status, notes, identifiedDate}], overallStatus, counselName, counselNotes, lastUpdated}

  // Documents (stored as JSON)
  documents       Json? // {transcript, pitchDeck}

  // Custom/Dynamic Data (LLM-organized categories from CSV upload)
  customData      Json? // { "categoryKey": { "fieldKey": "value", ... }, ... }
  customSchema    Json? // { "categoryKey": { displayName, sortOrder, fields: {...} }, ... }

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Optional: User ID for future multi-tenancy
  userId          String?

  // Indexes for performance
  @@index([rank])
  @@index([sector])
  @@index([pipelineStage])
  @@index([score])
  @@index([userId])
  @@index([sector, rank])
  @@index([pipelineStage, rank])
}

model ThresholdIssue {
  id              String   @id @default(uuid())
  startupId       String
  startup         Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  category        String // "Market Risk" | "Team Risk" | etc.
  issue           String
  riskRating      String // "High" | "Medium" | "Low"
  mitigation      String
  status          String   @default("Open") // "Open" | "In Progress" | "Resolved" | "Accepted Risk"
  identifiedDate  String?
  source          String   @default("Manual") // "AI" | "Manual" - tracks how issue was created

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([startupId])
  @@index([riskRating])
  @@index([status])
  @@index([source])
}

// NextAuth User Models
model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  role          String    @default("user") // "admin" | "user"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  shortlists    UserShortlist[]

  @@index([email])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// User-specific shortlist (many-to-many relationship)
model UserShortlist {
  id        String   @id @default(uuid())
  userId    String
  startupId String
  notes     String?  // Optional personal notes about why they shortlisted
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([userId, startupId]) // One shortlist entry per user per startup
  @@index([userId])
  @@index([startupId])
}

// =====================================
// PORTFOLIO MANAGEMENT MODELS
// =====================================

// Main Portfolio Investment - tracks our investment in a company
model PortfolioInvestment {
  id                    String   @id @default(uuid())
  startupId             String   @unique
  startup               Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  // Investment Details
  investmentDate        DateTime
  investmentAmount      Float    // USD invested
  investmentRound       String?  // "Pre-Seed", "Seed", "Series A", etc.
  investmentType        String   @default("equity") // "equity", "safe", "convertible", "debt"
  leadInvestor          Boolean  @default(false)
  boardSeat             Boolean  @default(false)
  boardObserver         Boolean  @default(false)

  // Valuation at Entry
  preMoneyValuation     Float?
  postMoneyValuation    Float?
  equityPercentage      Float?   // Our ownership % at entry

  // Current Status
  currentValuation      Float?   // Latest known valuation
  currentEquityPct      Float?   // Current ownership % (after dilution)
  lastValuationDate     DateTime?
  status                String   @default("active") // "active", "exited", "written_off"

  // Pro-rata Rights
  proRataRights         Boolean  @default(true)
  proRataAmount         Float?   // Amount we can invest in next round

  // Exit Information
  exitDate              DateTime?
  exitType              String?  // "IPO", "acquisition", "secondary", "buyback", "write_off"
  exitAmount            Float?   // Total amount returned
  exitMultiple          Float?   // MOIC (Multiple on Invested Capital)
  acquirer              String?  // Name of acquirer if acquisition

  // Notes
  investmentThesis      String?  // Why we invested
  notes                 String?

  // Related data
  followOnInvestments   FollowOnInvestment[]
  milestones            PortfolioMilestone[]
  updates               PortfolioUpdate[]
  boardMeetings         BoardMeeting[]
  communications        FounderCommunication[]
  kpiSnapshots          KPISnapshot[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
  @@index([investmentDate])
  @@index([exitDate])
}

// Follow-on Investments in the same company
model FollowOnInvestment {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime
  amount                Float
  round                 String?  // "Series B", "Series C", etc.
  preMoneyValuation     Float?
  postMoneyValuation    Float?
  leadInvestor          Boolean  @default(false)
  notes                 String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([portfolioInvestmentId])
  @@index([date])
}

// Key Milestones for portfolio companies
model PortfolioMilestone {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime
  title                 String
  category              String   // "funding", "product", "revenue", "team", "partnership", "customer", "other"
  description           String?
  impact                String?  // "positive", "negative", "neutral"

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([portfolioInvestmentId])
  @@index([date])
  @@index([category])
}

// Quarterly/Monthly Updates from Founders
model PortfolioUpdate {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime
  period                String   // "Q1 2024", "January 2024", etc.

  // Key Metrics (flexible JSON for different business models)
  metrics               Json?    // {mrr, arr, customers, growth, burn, runway, etc.}

  // Update Content
  highlights            String?  // Key wins
  challenges            String?  // Current challenges
  askFromInvestors      String?  // How we can help
  nextMilestones        String?  // What they're working on

  // Health Assessment
  overallHealth         String?  // "green", "yellow", "red"
  needsAttention        Boolean  @default(false)

  // Attachments (stored as JSON array of URLs/references)
  attachments           Json?    // [{name, url, type}]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([portfolioInvestmentId])
  @@index([date])
  @@index([overallHealth])
}

// Board Meetings
model BoardMeeting {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime
  type                  String   @default("regular") // "regular", "special", "annual"
  location              String?  // "Virtual", "SF Office", etc.

  // Agenda and Notes
  agenda                String?
  notes                 String?
  keyDecisions          String?
  actionItems           Json?    // [{item, owner, dueDate, status}]

  // Attendees
  attendees             Json?    // [{name, role, attended}]

  // Documents (stored as JSON array)
  documents             Json?    // [{name, url, type}]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([portfolioInvestmentId])
  @@index([date])
}

// Communication Log with Founders
model FounderCommunication {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime
  type                  String   // "call", "email", "meeting", "text", "other"
  subject               String?
  summary               String?
  participants          Json?    // [{name, role}]
  followUpRequired      Boolean  @default(false)
  followUpDate          DateTime?

  // Support Provided
  supportType           String?  // "intro", "advice", "recruiting", "fundraising", "other"
  supportDetails        String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([portfolioInvestmentId])
  @@index([date])
  @@index([type])
}

// KPI Snapshots for tracking performance over time
model KPISnapshot {
  id                    String   @id @default(uuid())
  portfolioInvestmentId String
  portfolioInvestment   PortfolioInvestment @relation(fields: [portfolioInvestmentId], references: [id], onDelete: Cascade)

  date                  DateTime

  // Financial KPIs
  mrr                   Float?   // Monthly Recurring Revenue
  arr                   Float?   // Annual Recurring Revenue
  revenue               Float?   // Total Revenue (for non-SaaS)
  grossMargin           Float?   // Percentage
  netBurn               Float?   // Monthly net burn
  runway                Float?   // Months of runway
  cash                  Float?   // Cash on hand

  // Growth KPIs
  revenueGrowthMoM      Float?   // Month over month %
  revenueGrowthYoY      Float?   // Year over year %

  // Customer KPIs
  customers             Int?     // Total customers
  newCustomers          Int?     // New customers this period
  churnRate             Float?   // Monthly churn %
  nrr                   Float?   // Net Revenue Retention %
  ltv                   Float?   // Lifetime Value
  cac                   Float?   // Customer Acquisition Cost
  ltvCacRatio           Float?   // LTV/CAC ratio

  // Team KPIs
  employees             Int?     // Total headcount

  // Custom KPIs (flexible JSON for industry-specific metrics)
  customKPIs            Json?    // {metricName: value, ...}

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([portfolioInvestmentId, date])
  @@index([portfolioInvestmentId])
  @@index([date])
}

// Portfolio-level documents (term sheets, SPAs, etc.)
model PortfolioDocument {
  id                    String   @id @default(uuid())
  startupId             String

  name                  String
  category              String   // "term_sheet", "spa", "side_letter", "board_consent", "financials", "cap_table", "other"
  description           String?
  fileUrl               String?  // URL to stored file
  fileType              String?  // "pdf", "docx", "xlsx", etc.
  fileSize              Int?     // Size in bytes

  // Version control
  version               Int      @default(1)
  isLatest              Boolean  @default(true)

  uploadedBy            String?  // User ID who uploaded

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([startupId])
  @@index([category])
}

// =====================================
// FOUNDER MANAGEMENT MODELS
// =====================================

// Founder - represents a person who can be associated with multiple companies
model Founder {
  id              String   @id @default(uuid())

  // Identity (for deduplication)
  name            String
  normalizedName  String   // Lowercase, trimmed for matching
  email           String?  @unique
  linkedIn        String?  @unique

  // Profile
  title           String?
  bio             String?  @db.Text
  location        String?
  photoUrl        String?

  // Background (structured JSON)
  education       Json?    // [{institution, degree, field, years}]
  experience      Json?    // [{company, role, description, years}]

  // Social Links
  twitter         String?
  github          String?
  website         String?

  // Metadata
  skills          String[]
  tags            String[]
  notes           String?  @db.Text
  source          String?  // "csv_upload", "manual"

  // Pipeline tracking
  pipelineStage   String   @default("Screening")

  // Custom data from CSV import (unmapped columns)
  customData      Json?    // { "categoryKey": { "fieldKey": "value", ... }, ... }
  customSchema    Json?    // { "categoryKey": { displayName, sortOrder, fields: {...} }, ... }

  // Relations
  companies       FounderCompany[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([normalizedName])
  @@index([name])
  @@index([pipelineStage])
}

// FounderCompany - junction table for many-to-many relationship
model FounderCompany {
  id              String   @id @default(uuid())

  founderId       String
  founder         Founder  @relation(fields: [founderId], references: [id], onDelete: Cascade)
  startupId       String
  startup         Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  // Role at this company
  role            String   @default("Founder")
  title           String?
  isPrimary       Boolean  @default(false)
  isActive        Boolean  @default(true)
  startDate       DateTime?
  endDate         DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([founderId, startupId])
  @@index([founderId])
  @@index([startupId])
}
